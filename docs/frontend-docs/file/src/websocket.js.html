<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/websocket.js | cesiumjs-webpack-tutorial</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-connectWebSocket">connectWebSocket</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-disconnectWebSocket">disconnectWebSocket</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/websocket.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import SockJS from &quot;sockjs-client&quot;;
import { Stomp } from &quot;@stomp/stompjs&quot;;
import {
  Ion,
  Viewer,
  Terrain,
  createOsmBuildingsAsync,
  Cartesian3,
  Math as CesiumMath,
  Color,
  PolygonHierarchy,
  Cartographic,
  LabelStyle,
  VerticalOrigin,
  Cartesian2
} from &quot;cesium&quot;;
import &quot;cesium/Widgets/widgets.css&quot;;

/**
 * @type {stompClient}
 * @desc websocket client
 */
let stompClient = null;

/**
 * @desc start websocket and subscribe to scenarios topic, edits map based on received events
 */
export function connectWebSocket() {
  const socket = new SockJS(&quot;http://localhost:8080/ws&quot;);
  stompClient = Stomp.over(socket);

  stompClient.onConnect = (frame) =&gt; {
    console.log(&quot;WebSocket Connected:&quot;, frame);

    stompClient.subscribe(&quot;/topic/scenarios&quot;, (message) =&gt; {
      const body = JSON.parse(JSON.parse(message.body)); // double parse if needed

      // Append event to scenario dashboard
      const scenarioDiv = document.createElement(&quot;div&quot;);
      scenarioDiv.textContent = `Event ${body.type} with ${body.polygonCoords}`;
      document.getElementById(&quot;scenario-status&quot;).appendChild(scenarioDiv);

      console.log(&quot;Received scenario event:&quot;, body);
      if(body.type == &quot;AREA_CREATED&quot;) {
        let polygonColor;
        switch (body.polygonColor) {
          case &quot;green&quot;:
            polygonColor = Color.GREEN.withAlpha(0.5);
            break;
          case &quot;red&quot;:
            polygonColor = Color.RED.withAlpha(0.5);
            break;
          case &quot;yellow&quot;:
            polygonColor = Color.YELLOW.withAlpha(0.5);
            break;
          default:
            polygonColor = Color.BLUE.withAlpha(0.5);
        }

        // --- Update Cesium map dynamically ---
        if (window.viewer) {
          try {
            const coords = body.polygonCoords.split(&quot;;&quot;).map(pair =&gt; {
              const [lon, lat] = pair.trim().split(&quot;,&quot;).map(Number);
              return Cartesian3.fromDegrees(lat, lon);
            });

            const area = window.viewer.entities.add({
              name: body.type+&quot;: &quot;+body.name,
              polygon: {
                hierarchy: new PolygonHierarchy(coords),
                material: polygonColor,
                outline: true,
                outlineColor: Color.BLACK
              }
            });

           window.viewer.zoomTo(window.viewer.entities);
          } catch (e) {
            console.error(&quot;Error creating polygon from event:&quot;, e);
          }
        }
      } else if(body.type == &quot;UNIT_ADDED&quot;) {
        let polygonColor;
        switch (body.polygonColor) {
          case &quot;green&quot;:
            polygonColor = Color.GREEN.withAlpha(0.5);
            break;
          case &quot;red&quot;:
            polygonColor = Color.RED.withAlpha(0.5);
            break;
          case &quot;yellow&quot;:
            polygonColor = Color.YELLOW.withAlpha(0.5);
            break;
          default:
            polygonColor = Color.BLUE.withAlpha(0.5);
        }
        const [lon, lat] = body.polygonCoords.trim().split(&apos;,&apos;).map(Number)
        const coords = Cartesian3.fromDegrees(lat, lon);
        const point = window.viewer.entities.add({
          name: body.name,
          position: coords,
          point: {
            pixelSize: 15,
            color: polygonColor,
            outlineColor: Color.WHITE,
            outlineWidth: 2,
          },
          label: {
            text: body.name,
            font: &quot;14pt monospace&quot;,
            style: LabelStyle.FILL_AND_OUTLINE,
            outlineWidth: 2,
            pixelOffset: new Cartesian2(0, -9),
            verticalOrigin: VerticalOrigin.BOTTOM
          }
        });
        window.viewer.zoomTo(window.viewer.entities);
        //window.viewer.zoomTo(point);
      }
      
    });
  };

  stompClient.onStompError = (error) =&gt; {
    console.error(&quot;STOMP Error:&quot;, error);
  };

  // Optional: reconnect on close
  stompClient.onWebSocketClose = () =&gt; {
    console.log(&quot;WebSocket closed. Attempting to reconnect in 5s...&quot;);
    setTimeout(connectWebSocket, 5000);
  };

  stompClient.activate();
}

/**
 * @desc disconnect from websocket
 */
export function disconnectWebSocket() {
  if (stompClient) {
    stompClient.deactivate();
    console.log(&quot;WebSocket disconnected&quot;);
  }
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
